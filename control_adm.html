<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Starchat - Painel ADM</title>
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <style>
    @font-face {
      font-family: 'PressStart2P';
      src: url('PressStart2P.ttf') format('truetype');
    }
    body {
      background-color: #000;
      color: #fff;
      font-family: 'PressStart2P', monospace;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      margin: 0 0 20px 0;
    }
    .admin-section {
      border: 1px solid #fff;
      padding: 15px;
      margin-bottom: 20px;
    }
    label, button {
      display: inline-block;
      margin: 5px 0;
    }
    input {
      padding: 5px;
      margin-bottom: 5px;
      background-color: #333;
      border: none;
      color: #fff;
    }
    button {
      background-color: #fff;
      color: #000;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
    }
    button:hover {
      background-color: #ccc;
    }
    .user-list {
      list-style: none;
      padding: 0;
    }
    .user-item {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Painel de Controle - Starchat</h1>
  <div class="admin-section">
    <h2>Adicionar Novo Admin</h2>
    <input type="text" id="newAdminNick" placeholder="Nome do usuário (nick)">
    <button onclick="addAdmin()">Adicionar Admin</button>
  </div>

  <div class="admin-section">
    <h2>Usuários Online</h2>
    <ul id="onlineUsers" class="user-list"></ul>
  </div>

  <script>
    // Conexão WebSocket com o mesmo host
    // Necessário para enviar comandos "internos" para o servidor
    const ws = new WebSocket(`wss://${window.location.host}`);

    // Quando conectar, não somos um "usuário normal", mas um "painel".
    // Podemos mandar um "nome" diferente ou ignorar. Aqui, vamos conectar sem mandar username.
    ws.onopen = () => {
      console.log('[ADM] Conexão estabelecida com o WebSocket.');
      // Podemos mandar algo para não ficar "Anônimo" no chat. 
      // Mas também podemos ignorar, pois o Painel não precisa "aparecer" no chat.
      ws.send(JSON.stringify({ type: 'connect', username: 'PainelADM' }));
    };

    // Recebe dados do servidor
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      // Precisamos de uma forma de descobrir quem está online. 
      // Uma opção simples: Mandar um comando +who (criar se quiser) e o servidor responde com a lista.
      // Por enquanto, sem esse comando no server, podemos "simular" de outra forma,
      // ou acessar via fetch GET (mas não implementamos rota).
      // 
      // Como exemplo didático, ignore "onlineUsers" e "user-item" se não houver +who. 
      // Vamos supor que a cada mensagem "system" quando user entra ou sai, atualizamos a lista.
      // -> Implementaremos um método "atualizaUsuariosOnline()" que envia +who para o servidor 
      //    e, quando retornar, atualizamos a lista.
      // 
      // Se quisermos receber +who, precisamos criar esse comando no server:
      //   - handleCommand(...): case '+who': retorna a lista de clients

      if (data.type === 'users_list') {
        // Vamos supor que data.users é um array de nicks
        refreshUserList(data.users);
      }
    };

    // Simulação de um comando +who
    function requestUserList() {
      // Precisamos que o servidor implemente esse comando. 
      // Ex: +who
      ws.send(JSON.stringify({
        type: 'message',
        username: 'PainelADM',
        message: '+who'
      }));
    }

    function refreshUserList(users) {
      const onlineUsers = document.getElementById('onlineUsers');
      onlineUsers.innerHTML = '';
      users.forEach(user => {
        const li = document.createElement('li');
        li.classList.add('user-item');
        li.innerHTML = `
          <span>${user}</span> 
          <button onclick="banUser('${user}')">Ban</button>
          <button onclick="unbanUser('${user}')">Unban</button>
          <button onclick="muteUser('${user}')">Mute</button>
          <button onclick="unmuteUser('${user}')">Unmute</button>
        `;
        onlineUsers.appendChild(li);
      });
    }

    function banUser(nick) {
      ws.send(JSON.stringify({
        type: 'message',
        username: 'PainelADM',
        message: `+ban ${nick}`
      }));
    }

    function unbanUser(nick) {
      ws.send(JSON.stringify({
        type: 'message',
        username: 'PainelADM',
        message: `+unban ${nick}`
      }));
    }

    function muteUser(nick) {
      ws.send(JSON.stringify({
        type: 'message',
        username: 'PainelADM',
        message: `+mute ${nick}`
      }));
    }

    function unmuteUser(nick) {
      ws.send(JSON.stringify({
        type: 'message',
        username: 'PainelADM',
        message: `+unmute ${nick}`
      }));
    }

    function addAdmin() {
      const newAdminNick = document.getElementById('newAdminNick').value.trim();
      if (!newAdminNick) {
        alert('Insira o nick do usuário para torná-lo admin.');
        return;
      }
      // Para adicionar um admin, precisamos injetar esse nick no array "admins" do server.
      // Não temos rota HTTP para isso. Então podemos fazer via fetch para uma rota /adm/add
      // ou mandar um "comando" especial. Vamos criar uma rota Express simples no server?

      fetch('/adm/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nick: newAdminNick, admin_pass: getParameterByName('admin_pass') })
      })
        .then(res => {
          if (res.status === 200) {
            alert(`Usuário ${newAdminNick} agora é Admin!`);
          } else {
            alert('Falha ao adicionar admin (verifique se a senha do painel está correta).');
          }
        })
        .catch(err => {
          console.error(err);
          alert('Erro ao adicionar admin.');
        });
    }

    // Função para pegar query strings (?admin_pass=1234)
    function getParameterByName(name) {
      const url = window.location.href;
      name = name.replace(/[\\[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      const results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    // Exemplo: pedir a lista de usuários quando entrar (se tivermos +who no server)
    // requestUserList();
  </script>
</body>
</html>
