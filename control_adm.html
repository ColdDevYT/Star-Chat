<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Starchat 2.0 - Painel ADM</title>
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <style>
    @font-face {
      font-family: 'PressStart2P';
      src: url('press-start-2p.ttf');
    }
    body {
      background-color: #000;
      color: #fff;
      font-family: 'PressStart2P', monospace;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      margin: 0 0 20px 0;
    }
    .admin-section {
      border: 1px solid #fff;
      padding: 15px;
      margin-bottom: 20px;
    }
    .user-list, .room-list {
      list-style: none;
      padding: 0;
    }
    .user-item, .room-item {
      margin-bottom: 10px;
    }
    input, button {
      font-family: 'PressStart2P', monospace;
    }
    input {
      background-color: #333;
      color: #fff;
      border: none;
      padding: 5px;
      margin-right: 8px;
    }
    button {
      background-color: #fff;
      color: #000;
      border: none;
      cursor: pointer;
      padding: 5px 10px;
      margin: 5px 0;
    }
    button:hover {
      background-color: #ccc;
    }
    label {
      display: inline-block;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>Painel de Controle - Starchat 2.0</h1>

  <!-- Adicionar Admin -->
  <div class="admin-section">
    <h2>Adicionar Admin</h2>
    <input type="text" id="newAdminNick" placeholder="Nome do usuário">
    <button onclick="addAdmin()">Adicionar Admin</button>
  </div>

  <!-- Definir Moderador -->
  <div class="admin-section">
    <h2>Definir Moderador</h2>
    <input type="text" id="modNick" placeholder="Nome do usuário">
    <button onclick="setMod()">Definir como Moderador</button>
  </div>

  <!-- Lista de usuários online -->
  <div class="admin-section">
    <h2>Usuários Online</h2>
    <ul id="onlineUsers" class="user-list"></ul>
  </div>

  <!-- Lista de canais -->
  <div class="admin-section">
    <h2>Canais Existentes</h2>
    <ul id="roomList" class="room-list"></ul>
  </div>

  <script>
    // Helper para pegar a senha da query
    function getParameterByName(name) {
      const url = window.location.href;
      name = name.replace(/[\\[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      const results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    const adminPass = getParameterByName('admin_pass') || '';

    // Conexão WebSocket
    const ws = new WebSocket(`wss://${window.location.host}`);

    ws.onopen = () => {
      console.log('[ADM] Conexão WS estabelecida');
      // Conecta sem exibir no chat, ou com nome 'PainelADM'
      ws.send(JSON.stringify({ type: 'connect', username: 'PainelADM' }));
      // Vamos solicitar dados de usuários/canais.  
      // Precisamos implementar +who e +list_rooms (ou algo similar) no server.  
      // Como exemplo, faremos sim: ws.send({ type: 'message', message: '+who' }); etc.
      // Por questão de exemplo, vamos suprimir e só exibir 'vazio' na UI.
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      // Precisamos de algo como data.type === 'users_list', data.users, etc.  
      // Caso implementemos +who no server, ele poderia retornar type: 'users_list'.  
      // Aqui iremos ficar só no esqueleto. Você pode criar seu comando no server e,
      // ao recebê-lo, popular a lista.

      console.log('[ADM] Mensagem WS:', data);
    };

    ws.onclose = () => {
      console.log('[ADM] WS desconectado');
    };

    // Envio de comandos para ban/mute/unmute, etc.
    function banUser(nick) {
      const cmd = `+ban ${nick}`;
      sendCommand(cmd);
    }
    function unbanUser(nick) {
      const cmd = `+unban ${nick}`;
      sendCommand(cmd);
    }
    function muteUser(nick) {
      const cmd = `+mute ${nick}`;
      sendCommand(cmd);
    }
    function unmuteUser(nick) {
      const cmd = `+unmute ${nick}`;
      sendCommand(cmd);
    }
    // Função genérica para mandar comandos como se estivesse no chat
    function sendCommand(cmd) {
      ws.send(JSON.stringify({ type: 'message', message: cmd }));
    }

    // Adicionar Admin
    function addAdmin() {
      const nick = document.getElementById('newAdminNick').value.trim();
      if (!nick) {
        alert('Informe o nick');
        return;
      }
      fetch('/adm/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nick, admin_pass: adminPass })
      })
        .then(res => {
          if (res.ok) {
            return res.json();
          }
          throw new Error(`Falha: ${res.status}`);
        })
        .then(json => {
          alert(json.message || 'Admin adicionado');
        })
        .catch(err => {
          alert('Erro ao adicionar admin');
          console.error(err);
        });
    }

    // Definir Moderador
    function setMod() {
      const nick = document.getElementById('modNick').value.trim();
      if (!nick) {
        alert('Informe o nick');
        return;
      }
      fetch('/adm/setmod', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nick, admin_pass: adminPass })
      })
        .then(res => {
          if (res.ok) {
            return res.json();
          }
          throw new Error(`Falha: ${res.status}`);
        })
        .then(json => {
          alert(json.message || 'Usuário agora é Mod');
        })
        .catch(err => {
          alert('Erro ao definir Mod');
          console.error(err);
        });
    }

    // TODO: Exibir usuários online e canais
    // Precisaríamos de comandos extra no server, ex.:
    // +who => server retorna { type: 'users_list', users: ['Fulano', ...] }
    // +list_rooms => { type: 'rooms_list', rooms: ['geral', 'dev', ...] }
    // A cada clique, atualizamos <ul> do HTML, ban, etc.
  </script>
</body>
</html>
